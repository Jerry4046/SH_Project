CREATE TABLE `account_tb` (
	`seq` INT(11) NOT NULL AUTO_INCREMENT COMMENT '계정 고유번호',
	`uuid` VARCHAR(50) NOT NULL COMMENT '로그인 ID' COLLATE 'utf8mb3_general_ci',
	`name` VARCHAR(10) NOT NULL COMMENT '사용자 이름' COLLATE 'utf8mb3_general_ci',
	`password` VARCHAR(100) NOT NULL COMMENT '비밀번호' COLLATE 'utf8mb3_general_ci',
	`grade` VARCHAR(3) NULL DEFAULT 'N' COMMENT '등급' COLLATE 'utf8mb3_general_ci',
	`situation` INT(11) NULL DEFAULT '0' COMMENT '상태 코드',
	PRIMARY KEY (`seq`) USING BTREE,
	UNIQUE INDEX `uuid` (`uuid`) USING BTREE
)
COMMENT='계정 정보'
COLLATE='utf8mb3_general_ci'
ENGINE=InnoDB
AUTO_INCREMENT=5
;

CREATE TABLE `client_tb` (
	`client_id` INT(11) NOT NULL AUTO_INCREMENT,
	`client_code` VARCHAR(10) NULL DEFAULT NULL COLLATE 'utf8mb3_general_ci',
	`company_initial` VARCHAR(10) NOT NULL COLLATE 'utf8mb3_general_ci',
	`manager_name` VARCHAR(50) NOT NULL COLLATE 'utf8mb3_general_ci',
	`branch_name` VARCHAR(100) NULL DEFAULT NULL COLLATE 'utf8mb3_general_ci',
	`agency_name` VARCHAR(100) NULL DEFAULT NULL COLLATE 'utf8mb3_general_ci',
	`address` VARCHAR(255) NULL DEFAULT NULL COLLATE 'utf8mb3_general_ci',
	`manager_phone` VARCHAR(20) NULL DEFAULT NULL COLLATE 'utf8mb3_general_ci',
	`regional_phone` VARCHAR(20) NULL DEFAULT NULL COLLATE 'utf8mb3_general_ci',
	`created_at` DATETIME NOT NULL DEFAULT current_timestamp(),
	`updated_at` DATETIME NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(),
	PRIMARY KEY (`client_id`) USING BTREE,
	UNIQUE INDEX `client_code` (`client_code`) USING BTREE
)
COLLATE='utf8mb3_general_ci'
ENGINE=InnoDB
AUTO_INCREMENT=5
;

CREATE TABLE `code_group_tb` (
	`group_code` VARCHAR(20) NOT NULL COLLATE 'utf8mb4_general_ci',
	`group_name` VARCHAR(50) NOT NULL COLLATE 'utf8mb4_general_ci',
	`description` VARCHAR(200) NULL DEFAULT NULL COLLATE 'utf8mb4_general_ci',
	`is_active` TINYINT(1) NOT NULL DEFAULT '1',
	`created_at` DATETIME NOT NULL DEFAULT current_timestamp(),
	PRIMARY KEY (`group_code`) USING BTREE
)
COLLATE='utf8mb4_general_ci'
ENGINE=InnoDB
;

CREATE TABLE `code_item_tb` (
	`group_code` VARCHAR(20) NOT NULL COLLATE 'utf8mb4_general_ci',
	`code` VARCHAR(30) NOT NULL COLLATE 'utf8mb4_general_ci',
	`code_name` VARCHAR(100) NOT NULL COLLATE 'utf8mb4_general_ci',
	`is_active` TINYINT(1) NOT NULL DEFAULT '1',
	`created_at` DATETIME NOT NULL DEFAULT current_timestamp(),
	PRIMARY KEY (`group_code`, `code`) USING BTREE,
	CONSTRAINT `fk_item_group` FOREIGN KEY (`group_code`) REFERENCES `code_group_tb` (`group_code`) ON UPDATE CASCADE ON DELETE RESTRICT
)
COLLATE='utf8mb4_general_ci'
ENGINE=InnoDB
;

CREATE TABLE `disposal_tb` (
	`disposal_id` BIGINT(20) NOT NULL AUTO_INCREMENT,
	`product_id` BIGINT(20) NOT NULL,
	`account_seq` INT(11) NOT NULL,
	`quantity` INT(11) NOT NULL,
	`reason` VARCHAR(255) NULL DEFAULT NULL COLLATE 'utf8mb3_general_ci',
	`disposed_at` DATETIME NOT NULL DEFAULT current_timestamp(),
	PRIMARY KEY (`disposal_id`) USING BTREE,
	INDEX `fk_disposal_product` (`product_id`) USING BTREE,
	INDEX `fk_disposal_account` (`account_seq`) USING BTREE,
	CONSTRAINT `fk_disposal_account` FOREIGN KEY (`account_seq`) REFERENCES `account_tb` (`seq`) ON UPDATE CASCADE ON DELETE RESTRICT,
	CONSTRAINT `fk_disposal_product` FOREIGN KEY (`product_id`) REFERENCES `product_tb` (`product_id`) ON UPDATE CASCADE ON DELETE RESTRICT
)
COLLATE='utf8mb3_general_ci'
ENGINE=InnoDB
;

CREATE TABLE `inventory_io_tb` (
	`io_id` BIGINT(20) NOT NULL AUTO_INCREMENT,
	`product_id` BIGINT(20) NOT NULL,
	`account_seq` INT(11) NOT NULL,
	`io_type` ENUM('IN','OUT') NOT NULL COLLATE 'utf8mb3_general_ci',
	`quantity` INT(11) NOT NULL COMMENT '요청 수량',
	`processed_quantity` INT(11) NOT NULL DEFAULT '0' COMMENT '실제 처리된 수량',
	`pending_quantity` INT(11) NOT NULL DEFAULT '0' COMMENT '미출고 수량',
	`balance_quantity` INT(11) NOT NULL DEFAULT '0' COMMENT '입출고 이후 재고 수량',
	`lot_number` VARCHAR(50) NULL DEFAULT NULL COMMENT '로트(배치) 번호' COLLATE 'utf8mb3_general_ci',
	`status` ENUM('REQUESTED','PARTIAL','COMPLETED','CANCELLED','FAILED') NOT NULL DEFAULT 'REQUESTED' COMMENT '입출고 처리 상태' COLLATE 'utf8mb3_general_ci',
	`pending_reason` VARCHAR(255) NULL DEFAULT NULL COMMENT '미출고 사유' COLLATE 'utf8mb3_general_ci',
	`scheduled_date` DATE NULL DEFAULT NULL COMMENT '캘린더 표시용 예정일',
	`io_date` DATETIME NOT NULL DEFAULT current_timestamp() COMMENT '입출고 기록 생성일시',
	`reference_table` VARCHAR(50) NULL DEFAULT NULL COLLATE 'utf8mb3_general_ci',
	`reference_id` BIGINT(20) NULL DEFAULT NULL,
	`reason` VARCHAR(255) NULL DEFAULT NULL COLLATE 'utf8mb3_general_ci',
	`memo` TEXT NULL DEFAULT NULL COLLATE 'utf8mb3_general_ci',
	`created_at` DATETIME NOT NULL DEFAULT current_timestamp(),
	`updated_at` DATETIME NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(),
	PRIMARY KEY (`io_id`) USING BTREE,
	INDEX `fk_io_product` (`product_id`) USING BTREE,
	INDEX `fk_io_account` (`account_seq`) USING BTREE,
	INDEX `ix_io_date` (`io_date`) USING BTREE,
	INDEX `ix_io_reference` (`reference_table`, `reference_id`) USING BTREE,
	INDEX `ix_io_status` (`status`, `scheduled_date`) USING BTREE,
	CONSTRAINT `fk_io_account` FOREIGN KEY (`account_seq`) REFERENCES `account_tb` (`seq`) ON UPDATE CASCADE ON DELETE RESTRICT,
	CONSTRAINT `fk_io_product` FOREIGN KEY (`product_id`) REFERENCES `product_tb` (`product_id`) ON UPDATE CASCADE ON DELETE RESTRICT
)
COMMENT='입출고 기록'
COLLATE='utf8mb3_general_ci'
ENGINE=InnoDB
;

CREATE TABLE `invoice_tb` (
	`invoice_id` BIGINT(20) NOT NULL AUTO_INCREMENT,
	`order_id` BIGINT(20) NOT NULL,
	`invoice_number` VARCHAR(50) NULL DEFAULT NULL COLLATE 'utf8mb3_general_ci',
	`status` ENUM('PRINTED','SHIPPED','PENDING') NOT NULL DEFAULT 'PENDING' COLLATE 'utf8mb3_general_ci',
	`printed_at` DATETIME NULL DEFAULT NULL,
	`shipped_at` DATETIME NULL DEFAULT NULL,
	`created_at` DATETIME NOT NULL DEFAULT current_timestamp(),
	`updated_at` DATETIME NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(),
	PRIMARY KEY (`invoice_id`) USING BTREE,
	INDEX `fk_invoice_order` (`order_id`) USING BTREE,
	CONSTRAINT `fk_invoice_order` FOREIGN KEY (`order_id`) REFERENCES `order_tb` (`order_id`) ON UPDATE CASCADE ON DELETE CASCADE
)
COLLATE='utf8mb3_general_ci'
ENGINE=InnoDB
;

CREATE TABLE `log_tb` (
	`log_id` BIGINT(20) NOT NULL AUTO_INCREMENT,
	`account_seq` INT(11) NULL DEFAULT NULL,
	`action` VARCHAR(50) NOT NULL COLLATE 'utf8mb3_general_ci',
	`target_table` VARCHAR(50) NOT NULL COLLATE 'utf8mb3_general_ci',
	`target_id` BIGINT(20) NULL DEFAULT NULL,
	`description` VARCHAR(255) NULL DEFAULT NULL COLLATE 'utf8mb3_general_ci',
	`created_at` DATETIME NOT NULL DEFAULT current_timestamp(),
	PRIMARY KEY (`log_id`) USING BTREE,
	INDEX `fk_log_account` (`account_seq`) USING BTREE,
	CONSTRAINT `fk_log_account` FOREIGN KEY (`account_seq`) REFERENCES `account_tb` (`seq`) ON UPDATE CASCADE ON DELETE SET NULL
)
COLLATE='utf8mb3_general_ci'
ENGINE=InnoDB
;

CREATE TABLE `order_tb` (
	`order_id` BIGINT(20) NOT NULL AUTO_INCREMENT,
	`client_id` INT(11) NOT NULL,
	`order_date` DATETIME NOT NULL DEFAULT current_timestamp(),
	`status` VARCHAR(20) NOT NULL DEFAULT 'pending' COLLATE 'utf8mb3_general_ci',
	`total_amount` DECIMAL(12,2) NULL DEFAULT '0.00',
	`created_at` DATETIME NOT NULL DEFAULT current_timestamp(),
	`updated_at` DATETIME NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(),
	PRIMARY KEY (`order_id`) USING BTREE,
	INDEX `fk_order_client` (`client_id`) USING BTREE,
	CONSTRAINT `fk_order_client` FOREIGN KEY (`client_id`) REFERENCES `client_tb` (`client_id`) ON UPDATE CASCADE ON DELETE RESTRICT
)
COLLATE='utf8mb3_general_ci'
ENGINE=InnoDB
;

CREATE TABLE `price_tb` (
	`price_id` BIGINT(20) NOT NULL AUTO_INCREMENT,
	`account_seq` INT(11) NOT NULL,
	`product_id` BIGINT(20) NOT NULL,
	`price` DECIMAL(12,2) NOT NULL DEFAULT '0.00',
	`currency` CHAR(3) NULL DEFAULT 'KRW' COLLATE 'utf8mb3_general_ci',
	`reason` VARCHAR(255) NULL DEFAULT NULL COLLATE 'utf8mb3_general_ci',
	`created_at` DATETIME NOT NULL DEFAULT current_timestamp(),
	`ended_at` DATETIME NULL DEFAULT NULL,
	PRIMARY KEY (`price_id`) USING BTREE,
	INDEX `ix_price_product` (`product_id`) USING BTREE,
	INDEX `ix_price_account` (`account_seq`) USING BTREE,
	CONSTRAINT `fk_price_account` FOREIGN KEY (`account_seq`) REFERENCES `account_tb` (`seq`) ON UPDATE CASCADE ON DELETE CASCADE,
	CONSTRAINT `fk_price_product` FOREIGN KEY (`product_id`) REFERENCES `product_tb` (`product_id`) ON UPDATE CASCADE ON DELETE CASCADE
)
COMMENT='제품 단가 이력'
COLLATE='utf8mb3_general_ci'
ENGINE=InnoDB
AUTO_INCREMENT=21
;

CREATE TABLE `product_change_history_tb` (
	`id` BIGINT(20) NOT NULL AUTO_INCREMENT,
	`product_id` BIGINT(20) NOT NULL,
	`field_name` VARCHAR(50) NOT NULL COLLATE 'utf8mb3_general_ci',
	`old_value` VARCHAR(255) NULL DEFAULT NULL COLLATE 'utf8mb3_general_ci',
	`new_value` VARCHAR(255) NULL DEFAULT NULL COLLATE 'utf8mb3_general_ci',
	`reason` VARCHAR(255) NOT NULL COLLATE 'utf8mb3_general_ci',
	`changed_by` INT(11) NOT NULL,
	`changed_at` DATETIME NULL DEFAULT current_timestamp(),
	PRIMARY KEY (`id`) USING BTREE,
	INDEX `fk_pch_product` (`product_id`) USING BTREE,
	CONSTRAINT `fk_pch_product` FOREIGN KEY (`product_id`) REFERENCES `product_tb` (`product_id`) ON UPDATE RESTRICT ON DELETE RESTRICT
)
COLLATE='utf8mb3_general_ci'
ENGINE=InnoDB
AUTO_INCREMENT=20
;

CREATE TABLE `product_tb` (
	`product_id` BIGINT(20) NOT NULL AUTO_INCREMENT,
	`account_seq` INT(11) NOT NULL,
	`product_code` VARCHAR(20) NOT NULL COLLATE 'utf8mb3_general_ci',
	`item_code` VARCHAR(10) NULL DEFAULT NULL COLLATE 'utf8mb3_general_ci',
	`pd_name` VARCHAR(100) NOT NULL COLLATE 'utf8mb3_general_ci',
	`spec` VARCHAR(100) NULL DEFAULT NULL COLLATE 'utf8mb3_general_ci',
	`pieces_per_box` INT(11) NOT NULL DEFAULT '1',
	`min_stock_quantity` INT(11) NOT NULL DEFAULT '0',
	`description` TEXT NULL DEFAULT NULL COLLATE 'utf8mb3_general_ci',
	`active` TINYINT(1) NOT NULL DEFAULT '1',
	`created_at` DATETIME NOT NULL DEFAULT current_timestamp(),
	`updated_at` DATETIME NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(),
	PRIMARY KEY (`product_id`) USING BTREE,
	UNIQUE INDEX `uq_account_product_code` (`account_seq`, `product_code`) USING BTREE,
	CONSTRAINT `fk_product_account` FOREIGN KEY (`account_seq`) REFERENCES `account_tb` (`seq`) ON UPDATE CASCADE ON DELETE RESTRICT
)
COLLATE='utf8mb3_general_ci'
ENGINE=InnoDB
AUTO_INCREMENT=22
;

CREATE TABLE `sales_tb` (
	`sales_id` BIGINT(20) NOT NULL AUTO_INCREMENT,
	`order_id` BIGINT(20) NULL DEFAULT NULL,
	`product_id` BIGINT(20) NOT NULL,
	`quantity` INT(11) NOT NULL,
	`unit_price` DECIMAL(12,2) NOT NULL,
	`sales_amount` DECIMAL(12,2) AS (`quantity` * `unit_price`) stored,
	`sales_date` DATETIME NOT NULL DEFAULT current_timestamp(),
	`created_at` DATETIME NOT NULL DEFAULT current_timestamp(),
	PRIMARY KEY (`sales_id`) USING BTREE,
	INDEX `fk_sales_order` (`order_id`) USING BTREE,
	INDEX `fk_sales_product` (`product_id`) USING BTREE,
	CONSTRAINT `fk_sales_order` FOREIGN KEY (`order_id`) REFERENCES `order_tb` (`order_id`) ON UPDATE CASCADE ON DELETE SET NULL,
	CONSTRAINT `fk_sales_product` FOREIGN KEY (`product_id`) REFERENCES `product_tb` (`product_id`) ON UPDATE CASCADE ON DELETE RESTRICT
)
COLLATE='utf8mb3_general_ci'
ENGINE=InnoDB
;

CREATE TABLE `stock_history_tb` (
	`id` BIGINT(20) NOT NULL AUTO_INCREMENT,
	`product_id` BIGINT(20) NOT NULL,
	`account_seq` INT(11) NOT NULL,
	`action` ENUM('IN','OUT','ADJUST','DISPOSAL') NOT NULL COLLATE 'utf8mb3_general_ci',
	`change_qty` INT(11) NOT NULL,
	`old_sh_qty` INT(11) NOT NULL DEFAULT '0',
	`new_sh_qty` INT(11) NOT NULL DEFAULT '0',
	`old_hp_qty` INT(11) NOT NULL DEFAULT '0',
	`new_hp_qty` INT(11) NOT NULL DEFAULT '0',
	`old_total_qty` INT(11) NOT NULL,
	`new_total_qty` INT(11) NOT NULL,
	`reason` VARCHAR(255) NULL DEFAULT NULL COLLATE 'utf8mb3_general_ci',
	`created_at` DATETIME NOT NULL DEFAULT current_timestamp(),
	PRIMARY KEY (`id`) USING BTREE,
	INDEX `fk_history_product` (`product_id`) USING BTREE,
	INDEX `fk_history_account` (`account_seq`) USING BTREE,
	CONSTRAINT `fk_history_account` FOREIGN KEY (`account_seq`) REFERENCES `account_tb` (`seq`) ON UPDATE CASCADE ON DELETE CASCADE,
	CONSTRAINT `fk_history_product` FOREIGN KEY (`product_id`) REFERENCES `product_tb` (`product_id`) ON UPDATE CASCADE ON DELETE CASCADE
)
COMMENT='재고 변경 이력'
COLLATE='utf8mb3_general_ci'
ENGINE=InnoDB
AUTO_INCREMENT=17
;

CREATE TABLE `stock_tb` (
	`product_id` BIGINT(20) NOT NULL,
	`sh_qty` INT(11) NOT NULL DEFAULT '0',
	`hp_qty` INT(11) NOT NULL DEFAULT '0',
	`total_qty` INT(11) NOT NULL DEFAULT '0',
	`created_at` DATETIME NOT NULL DEFAULT current_timestamp(),
	`updated_at` DATETIME NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(),
	PRIMARY KEY (`product_id`) USING BTREE,
	CONSTRAINT `fk_stock_product` FOREIGN KEY (`product_id`) REFERENCES `product_tb` (`product_id`) ON UPDATE CASCADE ON DELETE CASCADE
)
COMMENT='현재 재고'
COLLATE='utf8mb3_general_ci'
ENGINE=InnoDB
;
